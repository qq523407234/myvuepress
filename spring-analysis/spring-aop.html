<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hello VuePress</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/myvuepress/6.png">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/myvuepress/assets/css/0.styles.c074b921.css" as="style"><link rel="preload" href="/myvuepress/assets/js/app.20c1a956.js" as="script"><link rel="preload" href="/myvuepress/assets/js/2.266e006a.js" as="script"><link rel="preload" href="/myvuepress/assets/js/6.992cfafa.js" as="script"><link rel="prefetch" href="/myvuepress/assets/js/10.36562884.js"><link rel="prefetch" href="/myvuepress/assets/js/11.e3b0955d.js"><link rel="prefetch" href="/myvuepress/assets/js/12.a46c8256.js"><link rel="prefetch" href="/myvuepress/assets/js/13.17e0273f.js"><link rel="prefetch" href="/myvuepress/assets/js/14.75367682.js"><link rel="prefetch" href="/myvuepress/assets/js/15.bb9f826c.js"><link rel="prefetch" href="/myvuepress/assets/js/16.7ba8f888.js"><link rel="prefetch" href="/myvuepress/assets/js/17.9df6d451.js"><link rel="prefetch" href="/myvuepress/assets/js/3.e21c6607.js"><link rel="prefetch" href="/myvuepress/assets/js/4.c3c1892a.js"><link rel="prefetch" href="/myvuepress/assets/js/5.3c9bf12c.js"><link rel="prefetch" href="/myvuepress/assets/js/7.fb087350.js"><link rel="prefetch" href="/myvuepress/assets/js/8.c50c28cf.js"><link rel="prefetch" href="/myvuepress/assets/js/9.57223a65.js">
    <link rel="stylesheet" href="/myvuepress/assets/css/0.styles.c074b921.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myvuepress/" class="home-link router-link-active"><!----> <span class="site-name">Hello VuePress</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myvuepress/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/myvuepress/spring-analysis/" class="nav-link router-link-active">
  SpringAnalysis
</a></div><div class="nav-item"><a href="https://www.vuepress.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/qq523407234/myvuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myvuepress/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/myvuepress/spring-analysis/" class="nav-link router-link-active">
  SpringAnalysis
</a></div><div class="nav-item"><a href="https://www.vuepress.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/qq523407234/myvuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/myvuepress/spring-analysis/" aria-current="page" class="sidebar-link">Spring</a></li><li><a href="/myvuepress/spring-analysis/Spring.html" class="sidebar-link">spring-core</a></li><li><a href="/myvuepress/spring-analysis/spring-aop.html" aria-current="page" class="active sidebar-link">spring-aop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#解析" class="sidebar-link">解析</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#代理子类生成" class="sidebar-link">代理子类生成</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#解析-2" class="sidebar-link">解析</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#代理生成" class="sidebar-link">代理生成</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#例子" class="sidebar-link">例子</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#原理" class="sidebar-link">原理</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#属性" class="sidebar-link">属性</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#栗子" class="sidebar-link">栗子</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#解析-3" class="sidebar-link">解析</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#原理-2" class="sidebar-link">原理</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#总结-2" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-aop.html#aop切面的坑" class="sidebar-link">AOP切面的坑</a></li></ul></li><li><a href="/myvuepress/spring-analysis/spring-boot.html" class="sidebar-link">spring-boot</a></li><li><a href="/myvuepress/spring-analysis/spring-context.html" class="sidebar-link">spring-context</a></li><li><a href="/myvuepress/spring-analysis/spring-mvc.html" class="sidebar-link">spring-mvc</a></li><li><a href="/myvuepress/spring-analysis/spring-task.html" class="sidebar-link">spring-task</a></li><li><a href="/myvuepress/spring-analysis/spring-transaction.html" class="sidebar-link">spring-transaction</a></li><li><a href="/myvuepress/spring-analysis/guava-cache.html" class="sidebar-link">guava-cache</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>Table of Contents</strong> <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="noopener noreferrer">DocToc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em></p> <p></p><div class="table-of-contents"><ul><li><a href="#解析">解析</a><ul><li><a href="#proxy-target-class-expose-proxy">proxy-target-class &amp; expose-proxy</a></li><li><a href="#aop-pointcut">aop:pointcut</a></li><li><a href="#aop-advisor">aop:advisor</a></li><li><a href="#aop-aspect">aop:aspect</a></li></ul></li><li><a href="#代理子类生成">代理子类生成</a><ul><li><a href="#入口">入口</a></li><li><a href="#postprocessbeforeinstantiation">postProcessBeforeInstantiation</a></li><li><a href="#postprocessafterinitialization">postProcessAfterInitialization</a></li></ul></li><li><a href="#解析">解析</a><ul><li><a href="#入口">入口</a></li><li><a href="#装饰">装饰</a></li></ul></li><li><a href="#代理生成">代理生成</a><ul><li><a href="#advisor">Advisor</a></li><li><a href="#引入">引入</a></li></ul></li><li><a href="#例子">例子</a><ul><li><a href="#自定义scope">自定义Scope</a></li><li><a href="#配置">配置</a></li><li><a href="#测试">测试</a></li></ul></li><li><a href="#原理">原理</a><ul><li><a href="#dogetbean">doGetBean</a></li><li><a href="#代理子类">代理子类</a></li><li><a href="#callbackfilter-callback">CallbackFilter &amp; Callback</a></li><li><a href="#回调">回调</a></li></ul></li><li><a href="#属性">属性</a><ul><li><a href="#proxy-target-class">proxy-target-class</a></li><li><a href="#expose-proxy">expose-proxy</a></li></ul></li><li><a href="#栗子">栗子</a><ul><li><a href="#切面">切面</a></li><li><a href="#被代理类">被代理类</a></li><li><a href="#配置">配置</a></li></ul></li><li><a href="#解析">解析</a></li><li><a href="#原理">原理</a></li><li><a href="#总结">总结</a></li><li><a href="#aop切面的坑">AOP切面的坑</a><ul><li><a href="#总结">总结</a></li></ul></li></ul></div><p></p> <h1 id="开头"><a href="#开头" class="header-anchor">#</a> 开头</h1> <p>aop部分的解析器由AopNamespaceHandler注册，其init方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConfigBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;aspectj-autoproxy&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAutoProxyBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerBeanDefinitionDecorator</span><span class="token punctuation">(</span><span class="token string">&quot;scoped-proxy&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ScopedProxyBeanDefinitionDecorator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="aop-config"><a href="#aop-config" class="header-anchor">#</a> aop:config</h1> <p>此标签用以配置pointcut, advisor, aspect，实例:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* exam.service..*.*(..))<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transaction<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>advisor</span> <span class="token attr-name">advice-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transaction<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>ConfigBeanDefinitionParser.parse:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">BeanDefinition</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Element</span> element<span class="token punctuation">,</span> <span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">CompositeComponentDefinition</span> compositeDef <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">CompositeComponentDefinition</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">getTagName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            parserContext<span class="token punctuation">.</span><span class="token function">extractSource</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parserContext<span class="token punctuation">.</span><span class="token function">pushContainingComponent</span><span class="token punctuation">(</span>compositeDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否生成代理类</span>
    <span class="token function">configureAutoProxyCreator</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Element</span><span class="token punctuation">&gt;</span></span> childElts <span class="token operator">=</span> <span class="token class-name">DomUtils</span><span class="token punctuation">.</span><span class="token function">getChildElements</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Element</span> elt<span class="token operator">:</span> childElts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> localName <span class="token operator">=</span> parserContext<span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocalName</span><span class="token punctuation">(</span>elt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>POINTCUT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>localName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">parsePointcut</span><span class="token punctuation">(</span>elt<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ADVISOR<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>localName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">parseAdvisor</span><span class="token punctuation">(</span>elt<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ASPECT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>localName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">parseAspect</span><span class="token punctuation">(</span>elt<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    parserContext<span class="token punctuation">.</span><span class="token function">popAndRegisterContainingComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="解析"><a href="#解析" class="header-anchor">#</a> 解析</h2> <p>解析的过程主要分为以下几个部分。</p> <h3 id="proxy-target-class-expose-proxy"><a href="#proxy-target-class-expose-proxy" class="header-anchor">#</a> proxy-target-class &amp; expose-proxy</h3> <p>对应着aop:config的两个属性，前者代表是否为被代理这生成CGLIB子类，默认false，只为接口生成代理子类(话说如果不生成子类那么怎么拦截?)。后者代表是否将代理bean暴露给用户，如果暴露，可以通过Spring AopContext类获得，默认不暴露。</p> <p>解析的过程无非就是属性的读取，不再详细说明。</p> <h3 id="aop-pointcut"><a href="#aop-pointcut" class="header-anchor">#</a> aop:pointcut</h3> <p>pointcut的解析是一个生成一个BeanDefinition并将其id, expression等属性保存在BeanDefinition中。注意以下几点:</p> <ul><li>BeanDefinition的ID来自于id属性，如果没有，那么自动生成。</li> <li>BeanDefinition的class是AspectJExpressionPointcut。</li> <li>BeanDefinition的scope为prototype。</li></ul> <p>AspectJExpressionPointcut类图:</p> <p><img src="/myvuepress/assets/img/AspectJExpressionPointcut.aa9dd45e.jpg" alt="AspectJExpressionPointcut类图"></p> <h3 id="aop-advisor"><a href="#aop-advisor" class="header-anchor">#</a> aop:advisor</h3> <p>首先是其所有属性的示例:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>advisor</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">order</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">advice-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aopAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>advisor概念是Spring独有的，来自于上古时代，应该是较早时候的aop概念的实现: <a href="http://aopalliance.sourceforge.net/" target="_blank" rel="noopener noreferrer">AOP Alliance (Java/J2EE AOP standards)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。Spring官方的说法: <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop.html#aop-schema-advisors" target="_blank" rel="noopener noreferrer">aop-schema-advisors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>其相关的包/类就在spring-aop下:</p> <p><img src="/myvuepress/assets/img/aopalliance.f2702935.png" alt="aopalliance包"></p> <p>advice-ref是必须的属性，<strong>并且这里的advice必须实现org.aopalliance.aop.Advice的子接口</strong>。这些子接口指的什么呢，见Spring官方文档: <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/aop-api.html#aop-api-advice-types" target="_blank" rel="noopener noreferrer">aop-api-advice-types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。比如org.aopalliance.intercept.MethodInterceptor。</p> <p>最常见的用途就是结合事务使用:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>get*<span class="token punctuation">&quot;</span></span> <span class="token attr-name">read-only</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">propagation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>NOT_SUPPORTED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>find*<span class="token punctuation">&quot;</span></span> <span class="token attr-name">read-only</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">propagation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>NOT_SUPPORTED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>*<span class="token punctuation">&quot;</span></span> <span class="token attr-name">propagation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>REQUIRED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* exam.service..*.*(..))<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transaction<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>advisor</span> <span class="token attr-name">advice-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transaction<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>解析的套路和楼上类似，只不过此处的beanClass是DefaultBeanFactoryPointcutAdvisor，其类图:</p> <p><img src="/myvuepress/assets/img/DefaultBeanFactoryPointcutAdvisor.d46beb78.jpg" alt="DefaultBeanFactoryPointcutAdvisor类图"></p> <p>另外注意对于pointcut和pointcut-ref两者处理的区别，对于pointcut属性，Spring会同样创建一个AspectJExpressionPointcut类型的BeanDefinition，对于pointcut-ref会生成一个RuntimeBeanReference对象指向原pointcut的引用。此类的类图:</p> <p><img src="/myvuepress/assets/img/RuntimeBeanReference.ce3f404b.jpg" alt="RuntimeBeanReference类图"></p> <p>可以看出，这种aop的实现需要实现各种接口，所以不应该再使用此种方式进行aop，除了Spring内部的实现。</p> <h3 id="aop-aspect"><a href="#aop-aspect" class="header-anchor">#</a> aop:aspect</h3> <p>配置举例:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aopAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base.aop.AopDemoAdvice<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token comment">&lt;!-- 必须配置，因为被代理的对象必须在Spring容器中 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aopDemo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base.aop.AopDemo<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pointcut<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* base.aop.AopDemo.send())<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aopAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beforeSend<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pointcut<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>afterSend<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pointcut<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>解析形成的BeanDefinition结构如下:</p> <div class="language-html extra-class"><pre class="language-html"><code>AspectComponentDefinition
    beanRefArray
        RuntimeBeanReference(aop:aspect的ref属性)
    beanDefArray
        // 被注册
        RootBeanDefinition(aop:declare-parents)
            beanClass: DeclareParentsAdvisor
            ConstructorArg
                implement-interface
                types-matching
                default-impl
                delegate-ref
        // 被注册
        RootBeanDefinition(aop:before,aop:after...)
            beanClass: AspectJPointcutAdvisor
            ConstructorArg
                RootBeanDefinition
                    beanClass: 由子标签决定
                    ConstructorArg
                        RootBeanDefinition
                            beanClass: MethodLocatingFactoryBean
                            properties
                                targetBeanName: aspectName
                                methodName: method属性
                        RootBeanDefinition
                            beanClass: SimpleBeanFactoryAwareAspectInstanceFactory
                            properties
                                aspectBeanName: aspectName
                        //还有pointcut定义和引用...
</code></pre></div><p>结构图里面的aspectName来自于aop:aspect的ref属性，此属性是必须配置的，因为Spring要知道aop:before等标签指定的方法是哪个bean/类/对象的方法。</p> <h4 id="aop-declare-parents"><a href="#aop-declare-parents" class="header-anchor">#</a> aop:declare-parents</h4> <p>对于aop:declare-parents子标签，其决定的是代理子类应该实现哪些接口:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>declare-parents</span> <span class="token attr-name">types-matching</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">implement-interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>此标签最终被解析成为beanClass为DeclareParentsAdvisor的BeanDefinition，并注册到容器中。其类图:</p> <p><img src="/myvuepress/assets/img/DeclareParentsAdvisor.24fea4a4.jpg" alt="DeclareParentsAdvisor类图"></p> <h4 id="其它"><a href="#其它" class="header-anchor">#</a> 其它</h4> <p>此处的其它指的是aop:before, aop:after等最核心的标签。其最终被解析为beanClass为AspectJPointcutAdvisor的BeanDefinition，类图:</p> <p><img src="/myvuepress/assets/img/AspectJPointcutAdvisor.2c472bc5.jpg" alt="AspectJPointcutAdvisor类图"></p> <p>正如上面结构图里所描述的，其构造参数为一个BeanDefintion，此对象的beanClass是不确定的，由aop:before/after中的before和after决定，代码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAdviceClass</span><span class="token punctuation">(</span><span class="token class-name">Element</span> adviceElement<span class="token punctuation">,</span> <span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> elementName <span class="token operator">=</span> parserContext<span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocalName</span><span class="token punctuation">(</span>adviceElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>BEFORE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>elementName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AspectJMethodBeforeAdvice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>AFTER<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>elementName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AspectJAfterAdvice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>AFTER_RETURNING_ELEMENT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>elementName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AspectJAfterReturningAdvice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>AFTER_THROWING_ELEMENT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>elementName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AspectJAfterThrowingAdvice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>AROUND<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>elementName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AspectJAroundAdvice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而此BeanDefintion的构造参数又由以下三个部分组成:</p> <h5 id="methodlocatingfactorybean"><a href="#methodlocatingfactorybean" class="header-anchor">#</a> MethodLocatingFactoryBean</h5> <p>第一个便是beanClass为此类型的BeanDefinition。其内部有一个methodName属性，存储的便是标签的method属性的值。其类图:</p> <p><img src="/myvuepress/assets/img/MethodLocatingFactoryBean.bcc109a9.jpg" alt="MethodLocatingFactoryBean类图"></p> <p>这个东西是干什么用的呢?其实是用于在指定的advice(aop:aspect的ref属性)中得到Method对象。入口在setBeanFactory方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">resolveSignature</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>methodName<span class="token punctuation">,</span> beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="simplebeanfactoryawareaspectinstancefactory"><a href="#simplebeanfactoryawareaspectinstancefactory" class="header-anchor">#</a> SimpleBeanFactoryAwareAspectInstanceFactory</h5> <p>其类图:</p> <p><img src="/myvuepress/assets/img/SimpleBeanFactoryAwareAspectInstanceFactory.bc9ba6b0.jpg" alt="SimpleBeanFactoryAwareAspectInstanceFactory类图"></p> <p>此类用于在BeanFactory中定位aspect bean，这个bean指的是谁?</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aopAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base.aop.AopDemoAdvice<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>就是它!查找很简单:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getAspectInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <p>从整个aop:aspect标签最终被解析为一个AspectJPointcutAdvisor来看，Spring在实现上仍将其作为Advisor的概念。</p> <h2 id="代理子类生成"><a href="#代理子类生成" class="header-anchor">#</a> 代理子类生成</h2> <p>关键在于AspectJAwareAdvisorAutoProxyCreator，此对象在ConfigBeanDefinitionParser的configureAutoProxyCreator方法中注册，其类图:</p> <p><img src="/myvuepress/assets/img/AspectJAwareAdvisorAutoProxyCreator.cc83663a.jpg" alt="AspectJAwareAdvisorAutoProxyCreator类图"></p> <p>那么子类生成的入口在哪里呢?</p> <h3 id="入口"><a href="#入口" class="header-anchor">#</a> 入口</h3> <p>从AspectJAwareAdvisorAutoProxyCreator的类图中可以看出，此类实现了SmartInstantiationAwareBeanPostProcessor接口，所以很容易想到入口应该位于此接口及其父接口(BeanPostProcessor)的相关方法中。实际上确实是这样的。</p> <h3 id="postprocessbeforeinstantiation"><a href="#postprocessbeforeinstantiation" class="header-anchor">#</a> postProcessBeforeInstantiation</h3> <h4 id="调用时机"><a href="#调用时机" class="header-anchor">#</a> 调用时机</h4> <p>先来回顾一下此方法在Bean创建的过程中的调用时机。</p> <p>AbstractAutowireCapableBeanFactory.createBean部分源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
<span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看出，调用发生在Bean实例的创建之前。</p> <h4 id="源码"><a href="#源码" class="header-anchor">#</a> 源码</h4> <p>AbstractAutoProxyCreator.postProcessBeforeInstantiation:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanName <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TargetSource</span> targetSource <span class="token operator">=</span> <span class="token function">getCustomTargetSource</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> 
                <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面分部分对其进行说明。</p> <h4 id="应该代理"><a href="#应该代理" class="header-anchor">#</a> 应该代理 ?</h4> <p>Spring首先会对当前的beanClass进行检查(是否应该/可以对其进行代理)。</p> <p>不应该代理的类分为两种情况:</p> <ul><li>用于实现AOP的Spring基础类，此种情况在isInfrastructureClass方法中完成检测(单词Infrastructure正是基础设施的意思)。</li> <li>子类定义的应该跳过的类，默认AbstractAutoProxyCreator的实现直接返回false，即都不应该跳过。</li></ul> <h5 id="基础类检测"><a href="#基础类检测" class="header-anchor">#</a> 基础类检测</h5> <p>AbstractAutoProxyCreator.isInfrastructureClass:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> retVal <span class="token operator">=</span> <span class="token class-name">Advice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token class-name">Pointcut</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token class-name">Advisor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token class-name">AopInfrastructureBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，任何Advice、Pointcut、Advisor、AopInfrastructureBean的子类都被当做Spring实现AOP的基础设施类。</p> <h5 id="跳过类检测"><a href="#跳过类检测" class="header-anchor">#</a> 跳过类检测</h5> <p>即shouldSkip方法。前面提到了，AbstractAutoProxyCreator的默认实现直接返回fasle，这一特性被子类AspectJAwareAdvisorAutoProxyCreator重写:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> candidateAdvisors <span class="token operator">=</span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Advisor</span> advisor <span class="token operator">:</span> candidateAdvisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">AspectJPointcutAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractAspectJAdvice</span><span class="token punctuation">)</span> advisor<span class="token punctuation">.</span><span class="token function">getAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAspectName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么此方法跳过的是谁呢？</p> <p>其实就是我们通过aop:aspect标签配置的切面，即:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aopAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base.aop.AopDemoAdvice<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aopAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>里的aopAdvice。</p> <p>从前面的aop:aspect一节中可以知道，Spring对于aop:config的解析其实是把aop:before/after等标签解析成为了AspectJPointcutAdvisor类型的BeanDefinition，而aopAdvice以AbstractAspectJAdvice的类型保存在其中。</p> <p>所以可以得出结论: <strong>Spring跳过的是适用于当前bean的Advisor的Advice/Aspect对象</strong>。</p> <h6 id="aop逻辑"><a href="#aop逻辑" class="header-anchor">#</a> AOP逻辑</h6> <p><img src="/myvuepress/assets/img/aop_logic.50038bba.jpg" alt="AOP逻辑图"></p> <p>那么Spring又是如何找到适用于当前bean的Advisor的呢?</p> <h6 id="advisor寻找"><a href="#advisor寻找" class="header-anchor">#</a> Advisor寻找</h6> <p>关键便是findCandidateAdvisors方法，此方法将逻辑委托给BeanFactoryAdvisorRetrievalHelper.findAdvisorBeans:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAdvisorBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> advisorNames <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 结果缓存</span>
        advisorNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedAdvisorBeanNames<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisorNames <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// 去容器中寻找</span>
            advisorNames <span class="token operator">=</span> <span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">beanNamesForTypeIncludingAncestors</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> <span class="token class-name">Advisor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cachedAdvisorBeanNames <span class="token operator">=</span> advisorNames<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>advisorNames<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> advisorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEligibleBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">Advisor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，首先是从容器中获取到所有的Advisor示例，然后调用isEligibleBean方法逐一判断Advisor是否适用于当前bean。</p> <h6 id="适用性检测"><a href="#适用性检测" class="header-anchor">#</a> 适用性检测</h6> <p>指的便是isEligibleBean方法。最终调用的是AbstractAdvisorAutoProxyCreator的同名方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isEligibleAdvisorBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而AbstractAdvisorAutoProxyCreator的子类AspectJAwareAdvisorAutoProxyCreator并没有覆盖此方法，所以此处会对<strong>容器中所有的Advisor的Advice进行跳过</strong>。</p> <h5 id="检测结果缓存"><a href="#检测结果缓存" class="header-anchor">#</a> 检测结果缓存</h5> <p>因为postProcessBeforeInstantiation方法会在每个bean初始化之前被调用，所以没有必要每次都真的进行基础类检测和跳过类检测，Spring使用了advisedBeans作为缓存用以提高性能。</p> <h4 id="targetsource"><a href="#targetsource" class="header-anchor">#</a> TargetSource</h4> <p>从源码中可以看出，对于自定义的TargetSource，Spring会立即执行代理子类的创建。Spring的代理其实是针对TargetSource的，其类图:</p> <p><img src="/myvuepress/assets/img/TargetSource.aa71319a.jpg" alt="TargetSource类图"></p> <p>关于此接口在此不展开叙述。</p> <h3 id="postprocessafterinitialization"><a href="#postprocessafterinitialization" class="header-anchor">#</a> postProcessAfterInitialization</h3> <p>AbstractAutoProxyCreator.postProcessAfterInitialization:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>关键便在于wrapIfNecessary方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> cacheKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//自定义TargetSource，已经进行过代理子类生成</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Create proxy if we have advice.</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> DO_NOT_PROXY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建</span>
        <span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>
                bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，在此方法的开头又进行了基础类以及跳过类的检测，再次不再赘述。</p> <h4 id="advisor寻找-2"><a href="#advisor寻找-2" class="header-anchor">#</a> Advisor寻找</h4> <p>即getAdvicesAndAdvisorsForBean方法，这里进行的便是去容器中寻找适用于当前bean的Advisor，最终调用的是</p> <p>AbstractAdvisorAutoProxyCreator.findEligibleAdvisors:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findEligibleAdvisors</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> candidateAdvisors <span class="token operator">=</span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> eligibleAdvisors <span class="token operator">=</span> <span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">,</span> beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">extendAdvisors</span><span class="token punctuation">(</span>eligibleAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eligibleAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        eligibleAdvisors <span class="token operator">=</span> <span class="token function">sortAdvisors</span><span class="token punctuation">(</span>eligibleAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> eligibleAdvisors<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>findCandidateAdvisors前面已经说过了。</p> <h5 id="适用性判断"><a href="#适用性判断" class="header-anchor">#</a> 适用性判断</h5> <p>findAdvisorsThatCanApply最终调用AopUtils.findAdvisorsThatCanApply:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> candidateAdvisors<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> candidateAdvisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> eligibleAdvisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Advisor</span> candidate <span class="token operator">:</span> candidateAdvisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span> <span class="token operator">&amp;&amp;</span> <span class="token function">canApply</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eligibleAdvisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">boolean</span> hasIntroductions <span class="token operator">=</span> <span class="token operator">!</span>eligibleAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Advisor</span> candidate <span class="token operator">:</span> candidateAdvisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// already processed</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canApply</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eligibleAdvisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> eligibleAdvisors<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>关键在于canApply方法，从源码中可以看出，对于Advisor的判断分为了IntroductionAdvisor以及非IntroductionAdvisor两种情况。</p> <p>这种分开处理导致了<strong>IntroductionAdvisor在Advisor链中总是位于非IntroductionAdvisor前面</strong>。</p> <p>canApply(candidate, clazz)其实等价于canApply(candidate, clazz, false):</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">canApply</span><span class="token punctuation">(</span><span class="token class-name">Advisor</span> advisor<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasIntroductions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> advisor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">PointcutAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PointcutAdvisor</span> pca <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PointcutAdvisor</span><span class="token punctuation">)</span> advisor<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">canApply</span><span class="token punctuation">(</span>pca<span class="token punctuation">.</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// It doesn't have a pointcut so we assume it applies.</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>很明显，对于引入Advisor与其它Advisor是两种不同的判断方式。</p> <h6 id="引入"><a href="#引入" class="header-anchor">#</a> 引入</h6> <p>引入的概念在下面aop:scoped-proxy中有提到。因为引入的目的在于动态地向一个类添加另一种功能(接口)，所以只要判断给定的类是否是要引入到的类即可。</p> <h6 id="其它-2"><a href="#其它-2" class="header-anchor">#</a> 其它</h6> <p>AopUtils.canApply:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">canApply</span><span class="token punctuation">(</span><span class="token class-name">Pointcut</span> pc<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasIntroductions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//是否Pointcut可以匹配当前类</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pc<span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">MethodMatcher</span> methodMatcher <span class="token operator">=</span> pc<span class="token punctuation">.</span><span class="token function">getMethodMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//是否Pointcut可以匹配所有方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>methodMatcher <span class="token operator">==</span> <span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// No need to iterate the methods if we're matching any method anyway...</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">IntroductionAwareMethodMatcher</span> introductionAwareMethodMatcher <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>methodMatcher <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAwareMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        introductionAwareMethodMatcher <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntroductionAwareMethodMatcher</span><span class="token punctuation">)</span> methodMatcher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> classes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getAllInterfacesForClassAsSet</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    classes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">:</span> classes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">getAllDeclaredMethods</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>introductionAwareMethodMatcher <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                    introductionAwareMethodMatcher
                        <span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                    methodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Spring的Pointcut由ClassFilter和MethodMatcher两部分组成，其中前者用以判断给定的类是否在Pointcut的匹配范围内，后者用以在ClassFilter匹配满足的情况下判断给定的方法是否在Pointcut匹配的范围内。</p> <p>从源码中可以看出，如果ClassFilter匹配得到满足并且Pointcut并不能匹配此类的任意方法，便会<strong>用反射的方法获取targetClass(被检测类)的全部方法逐一交由Pointcut的MethodMatcher进行检测</strong>。</p> <p>关于Pointcut表达式是如何解析及存储的在此不再展开。</p> <h5 id="advisor扩展"><a href="#advisor扩展" class="header-anchor">#</a> Advisor扩展</h5> <p>AbstractAdvisorAutoProxyCreator.extendAdvisors允许子类向Advisor链表中添加自己的Advisor。子类AspectJAwareAdvisorAutoProxyCreator重写了此方法，其逻辑是:</p> <p>如果Advisor链表中的Advisor含有AspectJ Advice，那么将会把一个ExposeInvocationInterceptor添加到链表的表头，目的在于将MethodInvocation以ThreadLocal的方式暴露给后面所有的Advisor，暂不知道具体的用途。</p> <h5 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h5> <p>即sortAdvisors方法，用于对实现了Ordered接口的Advisor进行排序。</p> <h4 id="创建"><a href="#创建" class="header-anchor">#</a> 创建</h4> <p>AbstractAutoProxyCreator.createProxy(略去非关键代码):</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors<span class="token punctuation">,</span> <span class="token class-name">TargetSource</span> targetSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ProxyFactory</span> proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxyFactory<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将interceptor适配为Advisor</span>
    <span class="token class-name">Advisor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> advisors <span class="token operator">=</span> <span class="token function">buildAdvisors</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Advisor</span> advisor <span class="token operator">:</span> advisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        proxyFactory<span class="token punctuation">.</span><span class="token function">addAdvisor</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token function">getProxyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="jdk动态代理-or-cglib"><a href="#jdk动态代理-or-cglib" class="header-anchor">#</a> JDK动态代理 or Cglib</h5> <p>由DefaultAopProxyFactory.createAopProxy方法决定使用何种方式创建代理子类。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">AopProxy</span> <span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AopConfigException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token function">hasNoUserSuppliedProxyInterfaces</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjenesisCglibAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>逻辑很明显，如果指定了(proxy-target-classs设为true)使用Cglib，那么就会使用Cglib的方式，如果没有指定(或为false)，那么先回检测被代理类是否实现了自己的接口，如果实现了，那么就采用JDK动态代理的方式。</p> <h5 id="jdk动态代理"><a href="#jdk动态代理" class="header-anchor">#</a> JDK动态代理</h5> <p>JdkDynamicAopProxy.getProxy:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//找到可以用来进行代理的接口</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> proxiedInterfaces <span class="token operator">=</span> <span class="token class-name">AopProxyUtils</span><span class="token punctuation">.</span><span class="token function">completeProxiedInterfaces</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//用来代理的接口中是否定义了equals或者是hashCode方法?</span>
    <span class="token comment">//结果保存在内部equalsDefined和hashCodeDefined两个成员变量中</span>
    <span class="token function">findDefinedEqualsAndHashCodeMethods</span><span class="token punctuation">(</span>proxiedInterfaces<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> proxiedInterfaces<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，关键的InvocationHandler参数其实就是JdkDynamicAopProxy自身。</p> <p>其invoke方法较长，源码就不贴了，下面进行分部分说明。</p> <h6 id="equals-hashcode"><a href="#equals-hashcode" class="header-anchor">#</a> equals &amp; hashCode</h6> <p>如果被代理类实现了equals或者是hashCode方法，那么生成的代理子类的equals、hashCode方法实际上执行的是JdkDynamicAopProxy相应方法的逻辑。</p> <p>invoke方法部分源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>equalsDefined <span class="token operator">&amp;&amp;</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isEqualsMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The target does not implement the equals(Object) method itself.</span>
    <span class="token keyword">return</span> <span class="token function">equals</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="链式调用"><a href="#链式调用" class="header-anchor">#</a> 链式调用</h6> <p>对于切点方法，比如前面aop:aspect示例配置中的beforeSend</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beforeSend<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pointcut<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>Spring会创建一个MethodInvocation对象对所有相关的Advisor进行链式调用。invoke相关源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> chain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
invocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span> retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="cglib"><a href="#cglib" class="header-anchor">#</a> Cglib</h5> <p>同样是对于Advisor的链式调用，不再详细展开。</p> <h1 id="aop-scoped-proxy"><a href="#aop-scoped-proxy" class="header-anchor">#</a> aop:scoped-proxy</h1> <p>此配置一般是这样使用:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userPreferences<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.foo.UserPreferences<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>session<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>scoped-proxy</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userManager<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.foo.UserManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userPreferences<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userPreferences<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>对于ref属性，<strong>只会在userManager初始化时注入一次</strong>。这会造成什么问题呢?以session的Scope为例，因为只会注入一次，所以，<strong>userManager引用的始终是同一个userPreferences对象，即使现在可能已经过时了</strong>。此配置便可以使userManager引用的其实是一个对代理的引用，所以可以始终获取到最新的userPreferences。</p> <p>其作用和注解@ScopedProxy相同。</p> <p>其解析由ScopedProxyBeanDefinitionDecorator完成，类图:</p> <p><img src="/myvuepress/assets/img/ScopedProxyBeanDefinitionDecorator.56e52ee9.jpg" alt="ScopedProxyBeanDefinitionDecorator类图"></p> <h2 id="解析-2"><a href="#解析-2" class="header-anchor">#</a> 解析</h2> <h3 id="入口-2"><a href="#入口-2" class="header-anchor">#</a> 入口</h3> <p>从类图可以看出，ScopedProxyBeanDefinitionDecorator和之前的解析器都不同，它的调用入口不同以往:</p> <p>DefaultBeanDefinitionDocumentReader.processBeanDefinition:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BeanDefinitionHolder</span> bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bdHolder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 装饰</span>
        bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>BeanDefinitionParserDelegate.decorateIfRequired:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token function">decorateIfRequired</span><span class="token punctuation">(</span>
        <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionHolder</span> originalDef<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> containingBd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> namespaceUri <span class="token operator">=</span> <span class="token function">getNamespaceURI</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>namespaceUri<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">NamespaceHandler</span> handler <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getNamespaceHandlerResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>namespaceUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> handler<span class="token punctuation">.</span>
                <span class="token function">decorate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> originalDef<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ParserContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> containingBd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> originalDef<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一目了然。</p> <p>这么做(装饰)的原因就是此标签是用在bean内部的，从decorate的方法签名可以看出，第二个便是父(bean)BeanDefinition，所以叫做装饰。</p> <h3 id="装饰"><a href="#装饰" class="header-anchor">#</a> 装饰</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token function">decorate</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionHolder</span> definition<span class="token punctuation">,</span> <span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> proxyTargetClass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Element</span> ele <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">)</span> node<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span>PROXY_TARGET_CLASS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            proxyTargetClass <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>PROXY_TARGET_CLASS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">=</span>
            <span class="token class-name">ScopedProxyUtils</span><span class="token punctuation">.</span>
            <span class="token function">createScopedProxy</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> parserContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proxyTargetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> targetBeanName <span class="token operator">=</span> <span class="token class-name">ScopedProxyUtils</span><span class="token punctuation">.</span><span class="token function">getTargetBeanName</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 空实现</span>
    parserContext<span class="token punctuation">.</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireComponentRegistered</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> holder<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>核心便是createScopedProxy方法，其源码较长，但是这个套路之前见识过了，就是一个偷天换日: 创建一个新的BeanDefinition对象，beanName为被代理的bean的名字，被代理的bean名字为scopedTarget.原名字。被代理的bean扔将被注册到容器中。</p> <p>新的BeanDefintion的beanClass为ScopedProxyFactoryBean，其类图:</p> <p><img src="/myvuepress/assets/img/ScopedProxyFactoryBean.b45775a4.jpg" alt="ScopedProxyFactoryBean类图"></p> <h2 id="代理生成"><a href="#代理生成" class="header-anchor">#</a> 代理生成</h2> <p>入口便是setBeanFactory方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConfigurableBeanFactory</span> cbf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">)</span> beanFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scopedTargetSource<span class="token punctuation">.</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ProxyFactory</span> pf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pf<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pf<span class="token punctuation">.</span><span class="token function">setTargetSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>scopedTargetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> beanType<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
        <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPrivate</span><span class="token punctuation">(</span>beanType<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// JDK动态代理可用的接口</span>
        pf<span class="token punctuation">.</span><span class="token function">setInterfaces</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getAllInterfacesForClass</span><span class="token punctuation">(</span>beanType<span class="token punctuation">,</span> cbf<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Add an introduction that implements only the methods on ScopedObject.</span>
    <span class="token class-name">ScopedObject</span> scopedObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultScopedObject</span>
        <span class="token punctuation">(</span>cbf<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopedTargetSource<span class="token punctuation">.</span><span class="token function">getTargetBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pf<span class="token punctuation">.</span><span class="token function">addAdvice</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DelegatingIntroductionInterceptor</span><span class="token punctuation">(</span>scopedObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Add the AopInfrastructureBean marker to indicate that the scoped proxy</span>
    <span class="token comment">// itself is not subject to auto-proxying! Only its target bean is.</span>
    pf<span class="token punctuation">.</span><span class="token function">addInterface</span><span class="token punctuation">(</span><span class="token class-name">AopInfrastructureBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> pf<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>cbf<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个套路上面也见过了。</p> <h3 id="advisor"><a href="#advisor" class="header-anchor">#</a> Advisor</h3> <p>核心的拦截逻辑是通过DelegatingIntroductionInterceptor来完成的，其类图:</p> <p><img src="/myvuepress/assets/img/DelegatingIntroductionInterceptor.1e9ca332.jpg" alt="DelegatingIntroductionInterceptor类图"></p> <p>AdvisedSupport.addAdvice方法将其转化为Advisor:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addAdvice</span><span class="token punctuation">(</span><span class="token keyword">int</span> pos<span class="token punctuation">,</span> <span class="token class-name">Advice</span> advice<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AopConfigException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>advice <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We don't need an IntroductionAdvisor for this kind of introduction:</span>
        <span class="token comment">// It's fully self-describing.</span>
        <span class="token function">addAdvisor</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultIntroductionAdvisor</span><span class="token punctuation">(</span>advice<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">IntroductionInfo</span><span class="token punctuation">)</span> advice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>advice <span class="token keyword">instanceof</span> <span class="token class-name">DynamicIntroductionAdvice</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We need an IntroductionAdvisor for this kind of introduction.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">addAdvisor</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultPointcutAdvisor</span><span class="token punctuation">(</span>advice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>显然，DelegatingIntroductionInterceptor被包装为DefaultIntroductionAdvisor对象。</p> <p>DelegatingIntroductionInterceptor到底是个什么东西呢?这其实就引出了Spring的Introduction(引入)概念。</p> <h3 id="引入-2"><a href="#引入-2" class="header-anchor">#</a> 引入</h3> <p>通常意义上的Spring AOP一般是在方法层面上进行逻辑的改变，而引入指的是在不修改类源码的情况下，<strong>直接为一个类添加新的功能</strong>。下面是一个引入使用的例子:</p> <p><a href="http://blog.csdn.net/lzghxjt/article/details/51974336" target="_blank" rel="noopener noreferrer">SpringAOP中的IntroductionInterceptor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h2> <h3 id="自定义scope"><a href="#自定义scope" class="header-anchor">#</a> 自定义Scope</h3> <p>为了便于测试，我们定义一个生存周期仅仅在于一次调用的Scope，源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OneScope</span> <span class="token keyword">implements</span> <span class="token class-name">Scope</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> objectFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;get被调用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">&quot;skywalker-&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//忽略其它方法</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将其注册到容器中，有两种方法:</p> <ul><li><p>在代码中:</p> <div class="language-java extra-class"><pre class="language-java"><code>context<span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerScope</span><span class="token punctuation">(</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OneScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>配置文件:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.springframework.beans.factory.config.CustomScopeConfigurer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>scopes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>map</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base.scope.OneScope<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>map</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <h3 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h3> <p>此时就可以使用我们自己的Scope了:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base.SimpleBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>simpleBean<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>student<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>student<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>student<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base.Student<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>one<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>scoped-proxy</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h3> <p>执行以下代码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">SimpleBean</span> simpleBean <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">SimpleBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>simpleBean<span class="token punctuation">.</span><span class="token function">getStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>simpleBean<span class="token punctuation">.</span><span class="token function">getStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到以下输出:</p> <div class="language-html extra-class"><pre class="language-html"><code>get被调用
skywalker-0
get被调用
skywalker-1
</code></pre></div><p>可以得出结论: <strong>当调用被代理的bean的方法时才会触发Scoped的语义，只是获得其对象(getStudent)没有效果</strong>。</p> <h2 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h2> <h3 id="dogetbean"><a href="#dogetbean" class="header-anchor">#</a> doGetBean</h3> <p>从根本上来说在于AbstractBeanFactory.doGetBean，部分源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//scope非prototype和Singleton</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> scopeName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Scope</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> scopedInstance <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
            <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>scopedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>scopes是BeanFactory内部的一个 LinkedHashMap&lt;String, Scope&gt;类型的对象。scope.get实际上调用的就是我们的OneSocpe的get方法，没有用到ObjectFactory。</p> <p>所以，<strong>每调用一次getBean，就会导致一个新的Sudent被创建并返回</strong>。</p> <h3 id="代理子类"><a href="#代理子类" class="header-anchor">#</a> 代理子类</h3> <p>还有一个关键的问题，从上面可以知道SimpleBean内部的student引用其实是一个CGLIB代理子类的对象，那么当调用这个代理对象的相应方法(比如getName)时，是怎样导致Student重新创建(或是getBean被调用)的?</p> <h3 id="callbackfilter-callback"><a href="#callbackfilter-callback" class="header-anchor">#</a> CallbackFilter &amp; Callback</h3> <p>必须首先理解下CGLIB的这两个概念。</p> <h4 id="callback"><a href="#callback" class="header-anchor">#</a> Callback</h4> <p><strong>Callback是Cglib所有自定义逻辑(增强)的共同接口</strong>。</p> <p>其简略类图:</p> <p><img src="/myvuepress/assets/img/Callback.aba8498c.jpg" alt="Callback类图"></p> <h4 id="callbackfilter"><a href="#callbackfilter" class="header-anchor">#</a> CallbackFilter</h4> <p><strong>在CGLib回调时可以设置对不同方法执行不同的回调逻辑，或者根本不执行回调。</strong></p> <p>jdk并不支持这么搞，只支持设置一个InvocationHandler处理(拦截)所有的方法。其类图:</p> <p><img src="data:image/jpeg;base64,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" alt="CallbackFilter类图"></p> <p>Cglib的Enhancer可以指定一个Callback数组，而accept方法的返回值是一个int值，其实就是Callback数组的下标，这样便达到了指定回调逻辑的目的。</p> <p>参考:</p> <p><a href="http://blog.csdn.net/zghwaicsdn/article/details/50957474" target="_blank" rel="noopener noreferrer">CGLIB介绍与原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="回调"><a href="#回调" class="header-anchor">#</a> 回调</h3> <p>一般的方法使用的是DynamicAdvisedInterceptor作为回调逻辑，其intercept关键源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> target <span class="token operator">=</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>target就是被代理对象。</p> <p>getTarget:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>TargetSource前面说过了，默认是SimpleBeanTargetSource:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token function">getTargetBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，真相大白。</p> <h1 id="aop-aspectj-autoproxy"><a href="#aop-aspectj-autoproxy" class="header-anchor">#</a> aop:aspectj-autoproxy</h1> <p>此标签用以开启对于@AspectJ注解风格AOP的支持。</p> <h2 id="属性"><a href="#属性" class="header-anchor">#</a> 属性</h2> <h3 id="proxy-target-class"><a href="#proxy-target-class" class="header-anchor">#</a> proxy-target-class</h3> <p>你懂的。</p> <h3 id="expose-proxy"><a href="#expose-proxy" class="header-anchor">#</a> expose-proxy</h3> <p>是否应该把代理对象暴露给AopContext，默认false。</p> <h2 id="栗子"><a href="#栗子" class="header-anchor">#</a> 栗子</h2> <h3 id="切面"><a href="#切面" class="header-anchor">#</a> 切面</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AspectDemo</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(void base.aop.AopDemo.send(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;beforeSend()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;send之前&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="被代理类"><a href="#被代理类" class="header-anchor">#</a> 被代理类</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AopDemo</span> <span class="token keyword">implements</span> <span class="token class-name">AopDemoInter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;send from aopdemo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;receive from aopdemo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">inter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;inter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="配置-2"><a href="#配置-2" class="header-anchor">#</a> 配置</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspectj-autoproxy</span> <span class="token attr-name">proxy-target-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base.aop.AopDemo<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base.aop.annotation.AspectDemo<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>因为AopDemo实现了AopDemoInter接口，但做实验的send方法又不在此接口里定义，所以只能用cglib的方式代理。</p> <p>可以看出，<strong>即使标注了@Aspect注解，仍然需要将切面自己配置到Spring容器中。</strong></p> <h2 id="解析-3"><a href="#解析-3" class="header-anchor">#</a> 解析</h2> <p>AspectJAutoProxyBeanDefinitionParser.parse:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">BeanDefinition</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Element</span> element<span class="token punctuation">,</span> <span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AopNamespaceUtils</span><span class="token punctuation">.</span>
        <span class="token function">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">extendBeanDefinition</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注册最终在AopConfigUtils.registerOrEscalateApcAsRequired方法中完成，创建器实际上是一个AnnotationAwareAspectJAutoProxyCreator类的对象，此类是前面AspectJAwareAdvisorAutoProxyCreator的子类。</p> <h2 id="原理-2"><a href="#原理-2" class="header-anchor">#</a> 原理</h2> <p>既然是AspectJAwareAdvisorAutoProxyCreator的子类，那么其代理子类的创建等核心逻辑自然是一样的。这里所需要关注的地方自然是所不一样的地方: 即是如何体现其注解的特性的。</p> <p>前面说过，AspectJAwareAdvisorAutoProxyCreator通过findCandidateAdvisors方法来找到适用于bean的Advisor，所以注解的特性也是通过重写此方法来体现。</p> <p>AnnotationAwareAspectJAutoProxyCreator.findCandidateAdvisors:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//这里</span>
    advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorsBuilder<span class="token punctuation">.</span><span class="token function">buildAspectJAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>buildAspectJAdvisors方法所做的便是<strong>从容器中得到所有的bean，逐一判断是不是一个Aspect</strong>。那么判断Aspect的依据是什么?</p> <p>AbstractAspectJAdvisorFactory.isAspect:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAspect</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">hasAspectAnnotation</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">compiledByAjc</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至于其它的实现细节不再探究。</p> <h2 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h2> <p>Spring对于AspectJ风格AOP的支持停留在外表(注解)上面，内部的实现仍然是自己的东西。</p> <h1 id="拾遗"><a href="#拾遗" class="header-anchor">#</a> 拾遗</h1> <h2 id="aop切面的坑"><a href="#aop切面的坑" class="header-anchor">#</a> AOP切面的坑</h2> <ol><li>定义在private方法上的切面不会被执行，这个很容易理解，毕竟子类不能覆盖父类的私有方法。</li> <li>同一个代理子类内部的方法相互调用不会再次执行切面。</li></ol> <p>这里以Cglib为例对第二点进行说明，cglib的相关核心组件可以参考前面CallbackFilter &amp; Callback部分。对于配置了一个切面的典型场景，Spring内部的执行流程可总结如下图:</p> <p><img src="data:image/png;base64,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" alt="Cglib调用流程"></p> <p>核心便是对目标方法的调用上，这里由CglibMethodInvocation的invokeJoinpoint实现:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">invokeJoinpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>publicMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methodProxy<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">invokeJoinpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果是非public方法，那么Spring将使用反射的方法对其进行调用，因为反射将其可访问性设为true。MethodProxy是Cglib对方法代理的抽象，这里的关键是<strong>方法调用的对象(目标)是我们的原生类对象，而不是Cglib代理子类的对象，这就从根本上决定了对同类方法的调用不会再次经过切面</strong>。</p> <h3 id="总结-3"><a href="#总结-3" class="header-anchor">#</a> 总结</h3> <p>前面aop:aspectj-autoproxy-属性-expose-proxy一节提到了，Spring允许我们将代理子类暴露出来，可以进行如下配置:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span> <span class="token attr-name">expose-proxy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>advisor</span> <span class="token attr-name">advice-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>simpleMethodInterceptor<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* aop.SimpleAopBean.*(..))<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>当我们需要在一个被代理方法中调用同类的方法时(此方法也需要经过切面)，可以这样调用:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;testB执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SimpleAopBean</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">testC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里其实是一个ThreadLocal，当Cglib代理子类创建调用链之间便会将代理类设置到其中，DynamicAdvisedInterceptor.intercept相关源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>exposeProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Make invocation available if necessary.</span>
    oldProxy <span class="token operator">=</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    setProxyContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/myvuepress/spring-analysis/Spring.html" class="prev">
        spring-core
      </a></span> <span class="next"><a href="/myvuepress/spring-analysis/spring-boot.html">
        spring-boot
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/myvuepress/assets/js/app.20c1a956.js" defer></script><script src="/myvuepress/assets/js/2.266e006a.js" defer></script><script src="/myvuepress/assets/js/6.992cfafa.js" defer></script>
  </body>
</html>
