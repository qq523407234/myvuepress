<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hello VuePress</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/myvuepress/6.png">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/myvuepress/assets/css/0.styles.c074b921.css" as="style"><link rel="preload" href="/myvuepress/assets/js/app.cf12618a.js" as="script"><link rel="preload" href="/myvuepress/assets/js/2.266e006a.js" as="script"><link rel="preload" href="/myvuepress/assets/js/8.34cbbb14.js" as="script"><link rel="prefetch" href="/myvuepress/assets/js/10.36562884.js"><link rel="prefetch" href="/myvuepress/assets/js/11.e3b0955d.js"><link rel="prefetch" href="/myvuepress/assets/js/12.a46c8256.js"><link rel="prefetch" href="/myvuepress/assets/js/13.17e0273f.js"><link rel="prefetch" href="/myvuepress/assets/js/14.75367682.js"><link rel="prefetch" href="/myvuepress/assets/js/15.bb9f826c.js"><link rel="prefetch" href="/myvuepress/assets/js/16.7ba8f888.js"><link rel="prefetch" href="/myvuepress/assets/js/17.9df6d451.js"><link rel="prefetch" href="/myvuepress/assets/js/3.e21c6607.js"><link rel="prefetch" href="/myvuepress/assets/js/4.c3c1892a.js"><link rel="prefetch" href="/myvuepress/assets/js/5.ad3dd1ff.js"><link rel="prefetch" href="/myvuepress/assets/js/6.b7529a07.js"><link rel="prefetch" href="/myvuepress/assets/js/7.fb087350.js"><link rel="prefetch" href="/myvuepress/assets/js/9.e88e0a6a.js">
    <link rel="stylesheet" href="/myvuepress/assets/css/0.styles.c074b921.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myvuepress/" class="home-link router-link-active"><!----> <span class="site-name">Hello VuePress</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myvuepress/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/myvuepress/spring-analysis/" class="nav-link router-link-active">
  SpringAnalysis
</a></div><div class="nav-item"><a href="https://www.vuepress.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/qq523407234/myvuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myvuepress/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/myvuepress/spring-analysis/" class="nav-link router-link-active">
  SpringAnalysis
</a></div><div class="nav-item"><a href="https://www.vuepress.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/qq523407234/myvuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/myvuepress/spring-analysis/" aria-current="page" class="sidebar-link">Spring</a></li><li><a href="/myvuepress/spring-analysis/Spring.html" class="sidebar-link">spring-core</a></li><li><a href="/myvuepress/spring-analysis/spring-aop.html" class="sidebar-link">spring-aop</a></li><li><a href="/myvuepress/spring-analysis/spring-boot.html" class="sidebar-link">spring-boot</a></li><li><a href="/myvuepress/spring-analysis/spring-context.html" class="sidebar-link">spring-context</a></li><li><a href="/myvuepress/spring-analysis/spring-mvc.html" class="sidebar-link">spring-mvc</a></li><li><a href="/myvuepress/spring-analysis/spring-task.html" class="sidebar-link">spring-task</a></li><li><a href="/myvuepress/spring-analysis/spring-transaction.html" class="sidebar-link">spring-transaction</a></li><li><a href="/myvuepress/spring-analysis/guava-cache.html" aria-current="page" class="active sidebar-link">guava-cache</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/guava-cache.html#数据结构" class="sidebar-link">数据结构</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/guava-cache.html#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/guava-cache.html#hash算法" class="sidebar-link">Hash算法</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/guava-cache.html#rehash" class="sidebar-link">ReHash</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/guava-cache.html#segment选取" class="sidebar-link">Segment选取</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/guava-cache.html#segment-put" class="sidebar-link">Segment.put</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/guava-cache.html#get-key-hash-loader" class="sidebar-link">get(key,hash,loader)</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>Table of Contents</strong> <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="noopener noreferrer">DocToc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em></p> <p></p><div class="table-of-contents"><ul><li><a href="#数据结构">数据结构</a><ul><li><a href="#segments">segments</a></li><li><a href="#referenceentry">ReferenceEntry</a></li></ul></li><li><a href="#初始化">初始化</a><ul><li><a href="#referenceentry数组">ReferenceEntry数组</a></li><li><a href="#引用队列">引用队列</a></li></ul></li><li><a href="#hash算法">Hash算法</a></li><li><a href="#rehash">ReHash</a></li><li><a href="#segment选取">Segment选取</a></li><li><a href="#segment-put">Segment.put</a><ul><li><a href="#线程安全性">线程安全性</a></li><li><a href="#过期-垃圾缓存清理">过期/垃圾缓存清理</a></li><li><a href="#扩容">扩容</a></li><li><a href="#设值">设值</a></li></ul></li><li><a href="#get-key-hash-loader">get(key,hash,loader)</a></li></ul></div><p></p> <h1 id="创建"><a href="#创建" class="header-anchor">#</a> 创建</h1> <p>以CacheLoader的方式为例:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Hello: &quot;</span> <span class="token operator">+</span> s<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>创建的关键便在于build方法,build方法的核心逻辑位于LocalCache构造器，构造器完成了两件事:</p> <ul><li>将设置的属性从CacheBuilder复制到LocalCache。</li> <li>构造缓存存储的数据结构，此数据结构可以理解为一个自己实现的ConcurrentHashMap(分段锁)。</li></ul> <p>数据结构的示意图:</p> <p><img src="/myvuepress/assets/img/guava-cache.4dfacffa.jpg" alt="guava-cache"></p> <h2 id="数据结构"><a href="#数据结构" class="header-anchor">#</a> 数据结构</h2> <h3 id="segments"><a href="#segments" class="header-anchor">#</a> segments</h3> <p>Segment代表了其中的一段。其类图(部分):</p> <p><img src="/myvuepress/assets/img/Segment.0706b6f0.jpg" alt="Segment类图"></p> <p>此类继承ReentrantLock的目的在于方便的进行加锁操作。</p> <p>那么Segment的个数是如何确定的呢?</p> <p><strong>取最小的大于等于目的并行度的2的整次幂，如果设置了按权重大小的淘汰策略，那么还应注意总的权重值不超过给定的上限，每个Segment的权重按20计</strong>。</p> <p>相关源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">LocalCache</span><span class="token punctuation">(</span>
      <span class="token class-name">CacheBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> builder<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> loader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    concurrencyLevel <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">getConcurrencyLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MAX_SEGMENTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> segmentCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>segmentCount <span class="token operator">&lt;</span> concurrencyLevel <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">evictsBySize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> segmentCount <span class="token operator">*</span> <span class="token number">20</span> <span class="token operator">&lt;=</span> maxWeight<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">++</span>segmentShift<span class="token punctuation">;</span>
      segmentCount <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>并行度即并发修改缓存值的线程数，可以通过CacheBuilder的concurrencyLevel方法进行设置，默认4.</p> <h3 id="referenceentry"><a href="#referenceentry" class="header-anchor">#</a> ReferenceEntry</h3> <p>ReferenceEntry是guava-cache中实际进行存储的数据结构，其类图:</p> <p><img src="/myvuepress/assets/img/ReferenceEntry.d13a4369.jpg" alt="ReferenceEntry类图"></p> <p>那么在初始状态下，每个Segment中有多少个ReferenceEntry呢?</p> <p><strong>取最小的大于等于(initialCapacity / segmentCount)的2的整次幂的值</strong>。关键代码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">LocalCache</span><span class="token punctuation">(</span>
      <span class="token class-name">CacheBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> builder<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> loader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> segmentCapacity <span class="token operator">=</span> initialCapacity <span class="token operator">/</span> segmentCount<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>segmentCapacity <span class="token operator">*</span> segmentCount <span class="token operator">&lt;</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">++</span>segmentCapacity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> segmentSize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>segmentSize <span class="token operator">&lt;</span> segmentCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        segmentSize <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>initialCapacity由CacheBuilder的同名方法进行设置，默认16.</p> <h2 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h2> <p>关键代码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">LocalCache</span><span class="token punctuation">(</span>
      <span class="token class-name">CacheBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> builder<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> loader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">evictsBySize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Ensure sum of segment max weights = overall max weights</span>
        <span class="token keyword">long</span> maxSegmentWeight <span class="token operator">=</span> maxWeight <span class="token operator">/</span> segmentCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> remainder <span class="token operator">=</span> maxWeight <span class="token operator">%</span> segmentCount<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>segments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> remainder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                maxSegmentWeight<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>segments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>
                <span class="token function">createSegment</span><span class="token punctuation">(</span>segmentSize<span class="token punctuation">,</span> maxSegmentWeight<span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">getStatsCounterSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>segments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>segments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>
            <span class="token function">createSegment</span><span class="token punctuation">(</span>segmentSize<span class="token punctuation">,</span> UNSET_INT<span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">getStatsCounterSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，初始化根据是否启用了权重大小限制分为了两种情况，两种情况的区别在于maxSegmentWeight参数，用以指定此Segment的权重上限。</p> <p>createSegment其实就是对Segment构造器的调用，此构造器主要做了两件事:</p> <ul><li>初始化ReferenceEntry数组数据结构。</li> <li>初始化引用队列。</li></ul> <p>下面分开对其进行说明。</p> <h3 id="referenceentry数组"><a href="#referenceentry数组" class="header-anchor">#</a> ReferenceEntry数组</h3> <p>关键代码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Segment</span><span class="token punctuation">(</span><span class="token class-name">LocalCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> maxSegmentWeight<span class="token punctuation">,</span> <span class="token class-name">StatsCounter</span> statsCounter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token function">newEntryArray</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>newEntryArray方法只是创建了一个initialCapacity大小的数组，关键在于initTable:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token class-name">AtomicReferenceArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> newTable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> newTable<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 0.75</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">.</span><span class="token function">customWeigher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">==</span> maxSegmentWeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// prevent spurious expansion before eviction</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>threshold<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>table <span class="token operator">=</span> newTable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里完成的是对临界值的设置，超过此值数据将进行扩张。</p> <h3 id="引用队列"><a href="#引用队列" class="header-anchor">#</a> 引用队列</h3> <p>关键代码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Segment</span><span class="token punctuation">(</span><span class="token class-name">LocalCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> maxSegmentWeight<span class="token punctuation">,</span> <span class="token class-name">StatsCounter</span> statsCounter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//当不是强引用的时候成立</span>
    keyReferenceQueue <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">usesKeyReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    valueReferenceQueue <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">usesValueReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    recencyQueue <span class="token operator">=</span>
        map<span class="token punctuation">.</span><span class="token function">usesAccessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token class-name">LocalCache</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token function">discardingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    writeQueue <span class="token operator">=</span>
        map<span class="token punctuation">.</span><span class="token function">usesWriteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">WriteQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token class-name">LocalCache</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token function">discardingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    accessQueue <span class="token operator">=</span>
        map<span class="token punctuation">.</span><span class="token function">usesAccessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">AccessQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token class-name">LocalCache</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token function">discardingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>keyReferenceQueue和valueReferenceQueue用于结合软引用、弱引用以及虚引用使用，关于java中四种引用的区别以及ReferenceQueue的用途，参考:</p> <p><a href="http://blog.csdn.net/lyfi01/article/details/6415726" target="_blank" rel="noopener noreferrer">Java对象的强、软、弱和虚引用原理+结合ReferenceQueue对象构造Java对象的高速缓存器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>usesKeyReferences源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">usesKeyReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> keyStrength <span class="token operator">!=</span> <span class="token class-name">Strength</span><span class="token punctuation">.</span>STRONG<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>keyStrength通过CacheBuilder.getKeyStrength获取:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Strength</span> <span class="token function">getKeyStrength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">MoreObjects</span><span class="token punctuation">.</span><span class="token function">firstNonNull</span><span class="token punctuation">(</span>keyStrength<span class="token punctuation">,</span> <span class="token class-name">Strength</span><span class="token punctuation">.</span>STRONG<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，<strong>默认采用强引用的方式</strong>。我们可以通过CacheBuilder的softValues、weakKeys，weakValues方法对其进行设置。</p> <p>recencyQueue等队列将在后面结合get方法进行说明。</p> <h1 id="put"><a href="#put" class="header-anchor">#</a> put</h1> <p>LocalCache.put:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkNotNull</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkNotNull</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">segmentFor</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="hash算法"><a href="#hash算法" class="header-anchor">#</a> Hash算法</h2> <p>LocalCache.hash:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> keyEquivalence<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">rehash</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>keyEquivalence是策略模式的体现，针对不同的引用方式(LocalCache.Strength)提供不同的hash算法实现。</p> <p>Equivalence接口类图:</p> <p><img src="/myvuepress/assets/img/Equivalence.5a564d0b.jpg" alt="Equivalence类图"></p> <p>keyEquivalence属性由CacheBuilder的getKeyEquivalence方法获得:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Equivalence</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getKeyEquivalence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">MoreObjects</span><span class="token punctuation">.</span><span class="token function">firstNonNull</span><span class="token punctuation">(</span>keyEquivalence<span class="token punctuation">,</span> <span class="token function">getKeyStrength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">defaultEquivalence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，<strong>使用的hash算法与Strength相关联</strong>。Strength部分源码(仅展示defaultEquivalence方法):</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">enum</span> <span class="token class-name">Strength</span> <span class="token punctuation">{</span>
    STRONG <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token class-name">Equivalence</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">defaultEquivalence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Equivalence</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    SOFT <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token class-name">Equivalence</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">defaultEquivalence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Equivalence</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    WEAK <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token class-name">Equivalence</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">defaultEquivalence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Equivalence</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>以强引用为例。Equivalence.equals()返回的其实是一个单例的Equals对象，由上面类图可以看出，Equals是Equivalence的子类，源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Equals</span> <span class="token keyword">extends</span> <span class="token class-name">Equivalence</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Equals</span> INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Equals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">doEquivalent</span><span class="token punctuation">(</span><span class="token class-name">Object</span> a<span class="token punctuation">,</span> <span class="token class-name">Object</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doHash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">readResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，对于强引用来说，其哈希算法就是JDK Object的hashCode方法。</p> <p>而对于weak和soft引用来说，对应的是Identity实例，源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Identity</span> <span class="token keyword">extends</span> <span class="token class-name">Equivalence</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Identity</span> INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">doEquivalent</span><span class="token punctuation">(</span><span class="token class-name">Object</span> a<span class="token punctuation">,</span> <span class="token class-name">Object</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doHash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">readResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>identityHashCode返回的是<strong>默认hashCode方法的计算结果，即根据内存地址计算而来的结果</strong>。</p> <p>至于为什么要分开处理，暂时未知。</p> <h2 id="rehash"><a href="#rehash" class="header-anchor">#</a> ReHash</h2> <p>guava cache采用了和ConcurrentHashMap同样的算法。</p> <h2 id="segment选取"><a href="#segment选取" class="header-anchor">#</a> Segment选取</h2> <p>LocalCache.segmentFor:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">segmentFor</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> segments<span class="token punctuation">[</span><span class="token punctuation">(</span>hash <span class="token operator">&gt;&gt;&gt;</span> segmentShift<span class="token punctuation">)</span> <span class="token operator">&amp;</span> segmentMask<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>segmentShift和segmentMask的取值，LocalCache构造器源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> segmentShift <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> segmentCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>segmentCount <span class="token operator">&lt;</span> concurrencyLevel <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">evictsBySize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> segmentCount <span class="token operator">*</span> <span class="token number">20</span> <span class="token operator">&lt;=</span> maxWeight<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">++</span>segmentShift<span class="token punctuation">;</span>
    segmentCount <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>segmentShift <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">-</span> segmentShift<span class="token punctuation">;</span>
segmentMask <span class="token operator">=</span> segmentCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看出，寻找Segment的过程其实是对<strong>hashCode先取高n位，再取余的过程</strong>。</p> <h2 id="segment-put"><a href="#segment-put" class="header-anchor">#</a> Segment.put</h2> <p>源码很长，下面分部分说明。</p> <h3 id="线程安全性"><a href="#线程安全性" class="header-anchor">#</a> 线程安全性</h3> <p>部分源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
<span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">postWriteCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可见，核心逻辑都位于锁的保护之中。</p> <h3 id="过期-垃圾缓存清理"><a href="#过期-垃圾缓存清理" class="header-anchor">#</a> 过期/垃圾缓存清理</h3> <p>相关源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">long</span> now <span class="token operator">=</span> map<span class="token punctuation">.</span>ticker<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">preWriteCleanup</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ticker.read方法返回的实际上就是System.nanoTime的值。preWriteCleanup最终调用runLockedCleanup方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">runLockedCleanup</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//必定通过</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">drainReferenceQueues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">expireEntries</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// calls drainRecencyQueue</span>
            readCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="垃圾缓存"><a href="#垃圾缓存" class="header-anchor">#</a> 垃圾缓存</h4> <p>当引用类型是弱引用或是虚引用，垃圾缓存才会存在，当JVM对这些缓存进行回收时，会将已经失效的<strong>引用对象</strong>放到特定的ReferenceQueue中，清理便是针对此队列进行，防止无用的引用对象浪费内存空间。</p> <p>drainReferenceQueues:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">drainReferenceQueues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">usesKeyReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">drainKeyReferenceQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">usesValueReferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">drainValueReferenceQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以drainKeyReferenceQueue为例:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">drainKeyReferenceQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Reference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> ref<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ref <span class="token operator">=</span> keyReferenceQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
        <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> ref<span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">reclaimKey</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>i <span class="token operator">==</span> DRAIN_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>DRAIN_MAX取值16，猜测这样做的目的在于降低开销，防止一次put操作耗费过多的时间。</p> <p>reclaimKey用于清理ReferenceEntry对象，因为<strong>keyReference和valueReference是保存在此类中的</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">reclaimKey</span><span class="token punctuation">(</span><span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> entry<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> newCount <span class="token operator">=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">AtomicReferenceArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> table <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>table<span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> hash <span class="token operator">&amp;</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> first <span class="token operator">=</span> table<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> first<span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
                <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> newFirst <span class="token operator">=</span>
                    <span class="token function">removeValueFromChain</span><span class="token punctuation">(</span>
                        first<span class="token punctuation">,</span>
                        e<span class="token punctuation">,</span>
                        e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        hash<span class="token punctuation">,</span>
                        e<span class="token punctuation">.</span><span class="token function">getValueReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        e<span class="token punctuation">.</span><span class="token function">getValueReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">RemovalCause</span><span class="token punctuation">.</span>COLLECTED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                table<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> newFirst<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> newCount<span class="token punctuation">;</span> <span class="token comment">// write-volatile</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">postWriteCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意两点:</p> <ul><li>guava cache也是<strong>采用链表的形式解决hash冲突的</strong>。源码中for循环便是遍历链表寻找指定的引用的过程。</li> <li>removeValueFromChain方法真正的完成移除value的操作。</li></ul> <p>removeValueFromChain:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">removeValueFromChain</span><span class="token punctuation">(</span>
    <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> first<span class="token punctuation">,</span>
    <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> entry<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span>
    <span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token class-name">ValueReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> valueReference<span class="token punctuation">,</span> <span class="token class-name">RemovalCause</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enqueueNotification</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> value<span class="token punctuation">,</span> valueReference<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writeQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        accessQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>valueReference<span class="token punctuation">.</span><span class="token function">isLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valueReference<span class="token punctuation">.</span><span class="token function">notifyNewValue</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> first<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">removeEntryFromChain</span><span class="token punctuation">(</span>first<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="善后"><a href="#善后" class="header-anchor">#</a> 善后</h5> <p>enqueueNotification用于进行一些移除之后的善后工作(然而却是在 移除之前执行的):</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">enqueueNotification</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> weight<span class="token punctuation">,</span> <span class="token class-name">RemovalCause</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//减少权重</span>
    totalWeight <span class="token operator">-=</span> weight<span class="token punctuation">;</span>
    <span class="token comment">//分析统计</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cause<span class="token punctuation">.</span><span class="token function">wasEvicted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        statsCounter<span class="token punctuation">.</span><span class="token function">recordEviction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span>removalNotificationQueue <span class="token operator">!=</span> DISCARDING_QUEUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RemovalNotification</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> notification <span class="token operator">=</span> <span class="token class-name">RemovalNotification</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span>removalNotificationQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>notification<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>加入removalNotificationQueue的目的在于通知我们自定义的<strong>移除监听器</strong>，LocalCache构造器相关源码回顾:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//...</span>
removalListener <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">getRemovalListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    removalNotificationQueue <span class="token operator">=</span>
        <span class="token punctuation">(</span>removalListener <span class="token operator">==</span> <span class="token class-name">NullListener</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token class-name">LocalCache</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RemovalNotification</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token function">discardingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RemovalNotification</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
</code></pre></div><p>可以通过CacheBuilder的removalListener方法指定监听器。</p> <h5 id="writequeue移除"><a href="#writequeue移除" class="header-anchor">#</a> writeQueue移除</h5> <p>初始化在Segment构造器，相关源码:</p> <div class="language-java extra-class"><pre class="language-java"><code> writeQueue <span class="token operator">=</span>
          map<span class="token punctuation">.</span><span class="token function">usesWriteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">WriteQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token operator">:</span> <span class="token class-name">LocalCache</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferenceEntry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token function">discardingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>usesWriteQueue最终的逻辑在expiresAfterWrite:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">expiresAfterWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> expireAfterWriteNanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这其实是guava cache提供的一种缓存淘汰策略，即<strong>记录最后一次执行写入的时间，按照此时间间隔进行淘汰</strong>，WriteQueue用于按照写入的顺序进行排序，直接继承自JDK的AbstractQueue。</p> <p>此策略可以通过CacheBuilder的expireAfterWrite方法进行开启。</p> <p>WriteQueue利用了双端队列实现了时间轴的概念，即<strong>每次在队列前段插入新节点</strong>，示意:</p> <blockquote><p>----进入时间最短-----Enter--&gt;--D--&gt;--C--&gt;--B--&gt;--A--&gt;--进入时间最久-----</p></blockquote> <p>当需要进行回收的时候，只需要从前往后遍历队列，只要找到一个过期的缓存，那么可以保证<strong>此缓存后续的所有缓存都已过期.</strong></p> <h5 id="accessqueue移除"><a href="#accessqueue移除" class="header-anchor">#</a> accessQueue移除</h5> <p>原理和writeQueue一样，此策略通过CacheBuilder的expireAfterAccess方法进行开启。</p> <h5 id="加载终止"><a href="#加载终止" class="header-anchor">#</a> 加载终止</h5> <p>如果已被回收的key对应的value尚处于正在加载的状态，那么将终止加载过程。有意义的实现位于LoadingValueReference
(其它类均是空实现):</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyNewValue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">V</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The pending load was clobbered by a manual write.</span>
        <span class="token comment">// Unblock all pending gets, and have them return the new value.</span>
        <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// The pending load was removed. Delay notifications until loading completes.</span>
        oldValue <span class="token operator">=</span> <span class="token function">unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// TODO(fry): could also cancel loading if we had a handle on its future</span>
<span class="token punctuation">}</span>
</code></pre></div><p>unset方法返回一个占位符对象，此对象用以说明此ValueReference将被加载。</p> <h5 id="移除算法"><a href="#移除算法" class="header-anchor">#</a> 移除算法</h5> <p>真正的移除位于removeEntryFromChain方法中:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">removeEntryFromChain</span><span class="token punctuation">(</span><span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> first<span class="token punctuation">,</span> <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> newCount <span class="token operator">=</span> count<span class="token punctuation">;</span>
    <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> newFirst <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> first<span class="token punctuation">;</span> e <span class="token operator">!=</span> entry<span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> <span class="token function">copyEntry</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> newFirst<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newFirst <span class="token operator">=</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">removeCollectedEntry</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newCount<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> newCount<span class="token punctuation">;</span>
    <span class="token keyword">return</span> newFirst<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>移除算法并未采用从前往后遍历的方式，下面以图来说明。</p> <p>假设链表最初的结构如下所示:</p> <p><img src="data:image/png;base64,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" alt="初始"></p> <p>处理之后的结构:</p> <p><img src="data:image/png;base64,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" alt="之后"></p> <p>结合源码看出，<strong>节点移除实际上导致了一条新的链表的创建</strong>，那么为什么不采用直接将2和4连接的方式呢?</p> <p>WeakEntry部分源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">;</span>
<span class="token keyword">volatile</span> <span class="token class-name">ValueReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> valueReference <span class="token operator">=</span> <span class="token function">unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看出，next指针被定义为final，这样可以保证<strong>即使有读线程在并发(读操作是没有加锁的)地读取，也可以读取到数据，只不过是过期的数据</strong>，这里是CopyOnWrite思想的体现。</p> <h4 id="过期缓存"><a href="#过期缓存" class="header-anchor">#</a> 过期缓存</h4> <p>expireEntries:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">expireEntries</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//recencyQueue和accessQueue区分不清，暂且跳过</span>
    <span class="token function">drainRecencyQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> writeQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeEntry</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RemovalCause</span><span class="token punctuation">.</span>EXPIRED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> accessQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeEntry</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RemovalCause</span><span class="token punctuation">.</span>EXPIRED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>逻辑到这里就很明确了。</p> <h3 id="扩容"><a href="#扩容" class="header-anchor">#</a> 扩容</h3> <p>相关源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> newCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>newCount <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ensure capacity</span>
    <span class="token function">expand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>guava cache扩容仍然采用了ConcurrentHashMap的思想。<strong>扩容是针对Segment进行的，而不是整个Map，这样可以保证一个Segment的扩容不会对其它的Segment访问造成影响。</strong></p> <p><strong>扩容都是在原来的基础上进行两倍扩容</strong>，ConcurrentHashMap针对此特性做出了一定的优化措施，以原长度为16，扩容到32为例:</p> <p>16的Mask:</p> <p>01111</p> <p>32的Mask:</p> <p>11111</p> <p>也就是说，如果对象的hashCode的高一位是0，那么其在新数组中的位置其实是不变的，这些也就无需复制。</p> <p>源码不再贴出。</p> <h3 id="设值"><a href="#设值" class="header-anchor">#</a> 设值</h3> <p>。。。</p> <h1 id="get-key"><a href="#get-key" class="header-anchor">#</a> get(key)</h1> <p>即LocalLoadingCache.get:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> localCache<span class="token punctuation">.</span><span class="token function">getOrLoad</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>LocalCache.getOrLoad:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">V</span> <span class="token function">getOrLoad</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> defaultLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>defaultLoader便是在构造时指定的CacheLoader对象。</p> <p>LocalCache.get:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> loader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">segmentFor</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="get-key-hash-loader"><a href="#get-key-hash-loader" class="header-anchor">#</a> get(key,hash,loader)</h2> <p>Segment.get简略版源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> loader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//快速判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// read-volatile</span>
      <span class="token comment">//遍历寻找</span>
      <span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> <span class="token function">getEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> map<span class="token punctuation">.</span>ticker<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断Entry是否已经过期、被回收或是正在加载，如果是，返回null</span>
        <span class="token class-name">V</span> value <span class="token operator">=</span> <span class="token function">getLiveValue</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">recordRead</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
          statsCounter<span class="token punctuation">.</span><span class="token function">recordHits</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">scheduleRefresh</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> value<span class="token punctuation">,</span> now<span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ValueReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> valueReference <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getValueReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>valueReference<span class="token punctuation">.</span><span class="token function">isLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//阻塞等待直到加载完成</span>
          <span class="token keyword">return</span> <span class="token function">waitForLoadingValue</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> key<span class="token punctuation">,</span> valueReference<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// at this point e is either null or expired;</span>
    <span class="token comment">//加锁再次遍历或是加载</span>
    <span class="token keyword">return</span> <span class="token function">lockedGetOrLoad</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> ee<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> ee<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token function">postReadCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>逻辑注释里已经很清楚了，这里只需要补充一点，scheduleRefresh方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">V</span> <span class="token function">scheduleRefresh</span><span class="token punctuation">(</span><span class="token class-name">ReferenceEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> entry<span class="token punctuation">,</span><span class="token class-name">K</span> key<span class="token punctuation">,</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span><span class="token class-name">V</span> oldValue<span class="token punctuation">,</span><span class="token keyword">long</span> now<span class="token punctuation">,</span><span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> loader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">refreshes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> entry<span class="token punctuation">.</span><span class="token function">getWriteTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> map<span class="token punctuation">.</span>refreshNanos<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>entry<span class="token punctuation">.</span><span class="token function">getValueReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">V</span> newValue <span class="token operator">=</span> <span class="token function">refresh</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> newValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>refreshes()方法的条件是refreshNanos &gt; 0，这其实是guava cache提供的自动刷新机制，可以通过CacheBuilder的refreshAfterWrite方法进行设置。</p> <h1 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h1> <p>很好的两篇博客:</p> <p><a href="http://www.cnblogs.com/cm4j/p/cc_1.html" target="_blank" rel="noopener noreferrer">为什么ConcurrentHashMap可以这么快？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://www.cnblogs.com/cm4j/p/cc_2.html" target="_blank" rel="noopener noreferrer">高并发下数据写入与过期<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h1> <p>Guava cache其实是在ConcurrentHashMap的基础上加入了过期、权重、自动刷新等特性。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/myvuepress/spring-analysis/spring-transaction.html" class="prev">
        spring-transaction
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/myvuepress/assets/js/app.cf12618a.js" defer></script><script src="/myvuepress/assets/js/2.266e006a.js" defer></script><script src="/myvuepress/assets/js/8.34cbbb14.js" defer></script>
  </body>
</html>
