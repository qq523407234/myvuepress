<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hello VuePress</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/myvuepress/6.png">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/myvuepress/assets/css/0.styles.2bfc472b.css" as="style"><link rel="preload" href="/myvuepress/assets/js/app.7c286ba9.js" as="script"><link rel="preload" href="/myvuepress/assets/js/2.5a2a38e7.js" as="script"><link rel="preload" href="/myvuepress/assets/js/9.79c4b846.js" as="script"><link rel="prefetch" href="/myvuepress/assets/js/10.8584c02f.js"><link rel="prefetch" href="/myvuepress/assets/js/11.a41541ba.js"><link rel="prefetch" href="/myvuepress/assets/js/12.274c6e8a.js"><link rel="prefetch" href="/myvuepress/assets/js/13.316b9a34.js"><link rel="prefetch" href="/myvuepress/assets/js/14.232be02b.js"><link rel="prefetch" href="/myvuepress/assets/js/15.607bd9ec.js"><link rel="prefetch" href="/myvuepress/assets/js/16.5c8532ac.js"><link rel="prefetch" href="/myvuepress/assets/js/17.499eb44c.js"><link rel="prefetch" href="/myvuepress/assets/js/3.298ee711.js"><link rel="prefetch" href="/myvuepress/assets/js/4.8cb74713.js"><link rel="prefetch" href="/myvuepress/assets/js/5.483fafbe.js"><link rel="prefetch" href="/myvuepress/assets/js/6.4ae6af65.js"><link rel="prefetch" href="/myvuepress/assets/js/7.06e065e4.js"><link rel="prefetch" href="/myvuepress/assets/js/8.c48e72cf.js">
    <link rel="stylesheet" href="/myvuepress/assets/css/0.styles.2bfc472b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myvuepress/" class="home-link router-link-active"><!----> <span class="site-name">Hello VuePress</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myvuepress/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/myvuepress/spring-analysis/" class="nav-link router-link-active">
  SpringAnalysis
</a></div><div class="nav-item"><a href="https://www.vuepress.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/qq523407234/myvuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myvuepress/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/myvuepress/spring-analysis/" class="nav-link router-link-active">
  SpringAnalysis
</a></div><div class="nav-item"><a href="https://www.vuepress.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  External
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/qq523407234/myvuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/myvuepress/spring-analysis/" aria-current="page" class="sidebar-link">Spring</a></li><li><a href="/myvuepress/spring-analysis/Spring.html" class="sidebar-link">spring-core</a></li><li><a href="/myvuepress/spring-analysis/spring-aop.html" class="sidebar-link">spring-aop</a></li><li><a href="/myvuepress/spring-analysis/spring-boot.html" aria-current="page" class="active sidebar-link">spring-boot</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-boot.html#web环境检测" class="sidebar-link">web环境检测</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-boot.html#applicationcontextinitializer" class="sidebar-link">ApplicationContextInitializer</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-boot.html#applicationlistener" class="sidebar-link">ApplicationListener</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-boot.html#springapplicationrunlistener" class="sidebar-link">SpringApplicationRunListener</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-boot.html#starting" class="sidebar-link">starting</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-boot.html#环境准备" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header"><a href="/myvuepress/spring-analysis/spring-boot.html#environmentprepared" class="sidebar-link">environmentPrepared</a></li></ul></li><li><a href="/myvuepress/spring-analysis/spring-context.html" class="sidebar-link">spring-context</a></li><li><a href="/myvuepress/spring-analysis/spring-mvc.html" class="sidebar-link">spring-mvc</a></li><li><a href="/myvuepress/spring-analysis/spring-task.html" class="sidebar-link">spring-task</a></li><li><a href="/myvuepress/spring-analysis/spring-transaction.html" class="sidebar-link">spring-transaction</a></li><li><a href="/myvuepress/spring-analysis/guava-cache.html" class="sidebar-link">guava-cache</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>Table of Contents</strong> <em>generated with <a href="https://github.com/thlorenz/doctoc" target="_blank" rel="noopener noreferrer">DocToc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em></p> <p></p><div class="table-of-contents"><ul><li><a href="#web环境检测">web环境检测</a></li><li><a href="#applicationcontextinitializer">ApplicationContextInitializer</a></li><li><a href="#applicationlistener">ApplicationListener</a></li><li><a href="#springapplicationrunlistener">SpringApplicationRunListener</a></li><li><a href="#starting">starting</a></li><li><a href="#环境准备">环境准备</a><ul><li><a href="#属性来源">属性来源</a></li><li><a href="#profile配置">profile配置</a></li></ul></li><li><a href="#environmentprepared">environmentPrepared</a><ul><li><a href="#配置文件加载">配置文件加载</a></li></ul></li></ul></div><p></p> <h1 id="springapplication"><a href="#springapplication" class="header-anchor">#</a> SpringApplication</h1> <p>启动程序首先初始化了一个SpringApplication对象。来看一看在它的构造器了发生了什么。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> sources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">=</span> resourceLoader<span class="token punctuation">;</span>
	<span class="token function">initialize</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>initialize方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sources <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sources<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>sources<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>webEnvironment <span class="token operator">=</span> <span class="token function">deduceWebEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setInitializers</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span>
			<span class="token class-name">ApplicationContextInitializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setListeners</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>mainApplicationClass <span class="token operator">=</span> <span class="token function">deduceMainApplicationClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="web环境检测"><a href="#web环境检测" class="header-anchor">#</a> web环境检测</h2> <p>deduceWebEnvironment方法用于检测当前是否是web工程环境，检测的标准也很简单，classpath中必须同时存在下面这两个类:</p> <ul><li>javax.servlet.Servlet</li> <li>org.springframework.web.context.ConfigurableWebApplicationContext</li></ul> <h2 id="applicationcontextinitializer"><a href="#applicationcontextinitializer" class="header-anchor">#</a> ApplicationContextInitializer</h2> <p>下一步便是检测应当使用哪些ApplicationContextInitializer，这货并不是spring-boot的专属，而是定义在context下，这东西是在喜闻乐见的refesh方法执行之前留给我们进行自定义初始化的钩子。典型的使用的场景是注册我们自己的属性来源、设置激活的profile。</p> <p>在简单的web应用场景下(没有数据库/mybatis)，共最终引入了下列的类:</p> <p><img src="/myvuepress/assets/img/ApplicationContextInitializer.929e68bf.png" alt="ApplicationContextInitializer"></p> <p>来自于三个jar包:</p> <ul><li>spring-boot</li> <li>spring-boot-autoconfigure</li> <li>spring-beans</li></ul> <h2 id="applicationlistener"><a href="#applicationlistener" class="header-anchor">#</a> ApplicationListener</h2> <p>这货是典型的观察者模式实现，类图:</p> <p><img src="data:image/png;base64,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" alt="ApplicationListener"></p> <p>在简单的web应用场景下，系统共初始化了这些监听器:</p> <p><img src="/myvuepress/assets/img/ApplicationListener_used.dcec47ed.png" alt="ApplicationListener"></p> <h2 id="springapplicationrunlistener"><a href="#springapplicationrunlistener" class="header-anchor">#</a> SpringApplicationRunListener</h2> <p>就像它长得那样，就是用来监听SpringApplication的run方法的监听器。看看这货用到了哪些实现类:</p> <p><img src="data:image/png;base64,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" alt="SpringApplicationRunListener"></p> <h1 id="run"><a href="#run" class="header-anchor">#</a> run</h1> <p>从这一节开始，就进入了SpringApplication的run方法的势力范围。整个方法的流程总结如下图:</p> <p><img src="/myvuepress/assets/img/spring_application_run.e8060fc8.png" alt="SpringApplication.run"></p> <h2 id="starting"><a href="#starting" class="header-anchor">#</a> starting</h2> <p>SpringApplicationRunListener其实起一个广播器的作用，将消息广播给ApplicationListener一节初始化的10个Listener中的某几个。</p> <p>debug可以发现，对启动事件感兴趣的只有LoggingApplicationListener一个。</p> <p>当LoggingApplicationListener监听到启动事件时，所作的主要工作便是决定采用哪一个日志框架，其判断逻辑如下:</p> <ul><li><p>如果系统变量<code>org.springframework.boot.logging.LoggingSystem</code>存在，那么由其决定。</p></li> <li><p>依次检测classpath中这些类是否存在:</p> <div class="language-java extra-class"><pre class="language-java"><code>ch<span class="token punctuation">.</span>qos<span class="token punctuation">.</span>logback<span class="token punctuation">.</span>core<span class="token punctuation">.</span><span class="token class-name">Appender</span><span class="token punctuation">;</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span>core<span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token class-name">Log4jContextFactory</span><span class="token punctuation">;</span>
java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>logging<span class="token punctuation">.</span><span class="token class-name">LogManager</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h2 id="环境准备"><a href="#环境准备" class="header-anchor">#</a> 环境准备</h2> <p>相关源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> <span class="token function">prepareEnvironment</span><span class="token punctuation">(</span>listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Spring里面的Environment到底是个什么东西，详细参考隔壁(Spring.md)Environment接口一节，总结来说，这货就是属性配置来源(比如系统变量)和profile的综合体。</p> <h3 id="属性来源"><a href="#属性来源" class="header-anchor">#</a> 属性来源</h3> <p>在web环境下共初始化了以下4个属性来源:</p> <ul><li>System.getProperties()</li> <li>System.getenv()</li> <li>servlet-context-init-params</li> <li>servlet-config-init-params</li></ul> <p>有意思的问题：此时servlet-context-init-params和servlet-config-init-params实际上是一个占位符，无法从这两个来源获得任何真实的属性，等到refresh方法执行时才会被真实的来源替换。</p> <h3 id="profile配置"><a href="#profile配置" class="header-anchor">#</a> profile配置</h3> <p>SpringApplication.configureProfiles方法:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configureProfiles</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span> environment<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	environment<span class="token punctuation">.</span><span class="token function">getActiveProfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ensure they are initialized</span>
	<span class="token comment">// But these ones should go first (last wins in a property key clash)</span>
  	<span class="token comment">// 默认空</span>
	<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> profiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>additionalProfiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
	profiles<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token function">getActiveProfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	environment<span class="token punctuation">.</span><span class="token function">setActiveProfiles</span><span class="token punctuation">(</span>profiles<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>profiles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>active profile取自上一节中的属性来源，key为<code>spring.profiles.active</code>.</p> <h2 id="environmentprepared"><a href="#environmentprepared" class="header-anchor">#</a> environmentPrepared</h2> <h3 id="配置文件加载"><a href="#配置文件加载" class="header-anchor">#</a> 配置文件加载</h3> <p>监听器ConfigFileApplicationListener负责spring-boot配置文件的加载，ConfigFileApplicationListener默认会从以下的位置搜索配置文件:</p> <ol><li>classpath下的application.properties或application.yml</li> <li>file:./下的application.properties或application.yml</li> <li>classpath:config目录下的application.properties或application.yml</li> <li>file:./config目录下的application.properties或application.yml</li></ol> <p>此监听器是如何加载的?源码:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onApplicationEnvironmentPreparedEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEnvironmentPreparedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EnvironmentPostProcessor</span><span class="token punctuation">&gt;</span></span> postProcessors <span class="token operator">=</span> <span class="token function">loadPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	postProcessors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>postProcessors<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">EnvironmentPostProcessor</span> postProcessor <span class="token operator">:</span> postProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		postProcessor<span class="token punctuation">.</span><span class="token function">postProcessEnvironment</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				event<span class="token punctuation">.</span><span class="token function">getSpringApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>显然核心的加载操作是通过EnvironmentPostProcessor接口实现的，此接口允许我们在context刷新之前自定义配置加载，并且Spring推荐此接口的实现类同时实现Ordered接口。类图:</p> <p><img src="/myvuepress/assets/img/EnvironmentPostProcessor.dd64f140.png" alt="EnvironmentPostProcessor"></p> <p>加上ConfigFileApplicationListener自己，spring-boot默认共初始化了三个加载器，其它两个是SpringApplicationJsonEnvironmentPostProcessor和CloudFoundryVcapEnvironmentPostProcessor，下面按照其优先级顺序进行说明。</p> <h4 id="springapplicationjsonenvironmentpostprocessor"><a href="#springapplicationjsonenvironmentpostprocessor" class="header-anchor">#</a> SpringApplicationJsonEnvironmentPostProcessor</h4> <p>尝试读取spring.application.json或SPRING_APPLICATION_JSON系统指定的json配置文件，从这里加载的配置具有最高的优先级，当然，默认是没有的。</p> <h4 id="cloudfoundryvcapenvironmentpostprocessor"><a href="#cloudfoundryvcapenvironmentpostprocessor" class="header-anchor">#</a> CloudFoundryVcapEnvironmentPostProcessor</h4> <p>从Cloud Foundry加载配置，这是什么东西问度娘。</p> <h4 id="configfileapplicationlistener"><a href="#configfileapplicationlistener" class="header-anchor">#</a> ConfigFileApplicationListener</h4> <p>这里就是加载配置文件加载一节所说的配置文件的过程。</p> <p>TODO: 多profile配置文件加载</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/myvuepress/spring-analysis/spring-aop.html" class="prev">
        spring-aop
      </a></span> <span class="next"><a href="/myvuepress/spring-analysis/spring-context.html">
        spring-context
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/myvuepress/assets/js/app.7c286ba9.js" defer></script><script src="/myvuepress/assets/js/2.5a2a38e7.js" defer></script><script src="/myvuepress/assets/js/9.79c4b846.js" defer></script>
  </body>
</html>
